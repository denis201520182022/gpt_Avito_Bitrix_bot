# GPT-–±–æ—Ç –¥–ª—è –ê–≤–∏—Ç–æ –∏ Bitrix24

–ß–∞—Ç-–±–æ—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –ê–≤–∏—Ç–æ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤ –≤ Bitrix24. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç **FastAPI**, **OpenAI GPT** –∏ **Redis** –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–æ–≤. –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–æ–≤–∞–Ω —á–µ—Ä–µ–∑ **Docker** –∏ **Docker Compose**.

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
gpt_bot_Avito_Bitrix/
‚îú‚îÄ‚îÄ bot.py                    # –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥ –±–æ—Ç–∞
‚îú‚îÄ‚îÄ config.py                 # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ .env
‚îú‚îÄ‚îÄ requirements.txt          # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Python
‚îú‚îÄ‚îÄ bot.log                   # –õ–æ–≥–∏ —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞
‚îú‚îÄ‚îÄ README.md                 # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îú‚îÄ‚îÄ prompt.txt                # –§–∞–π–ª —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º
‚îú‚îÄ‚îÄ docker-compose.yml        # Docker Compose –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ Dockerfile                # Dockerfile –ø—Ä–æ–µ–∫—Ç–∞
‚îî‚îÄ‚îÄ __pycache__/              # –°–ª—É–∂–µ–±–Ω—ã–µ —Ñ–∞–π–ª—ã Python
```

## ‚öôÔ∏è –õ–æ–∫–∞–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫

### 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞:
```bash
git clone <your_repo_url>
cd gpt_bot_Avito_Bitrix
```

### 2. –°–æ–∑–¥–∞—ë–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ:
```bash
python -m venv venv
source venv/bin/activate     # Linux/macOS
venv\Scripts\activate        # Windows
```

### 3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
```bash
pip install -r requirements.txt
```

### 4. –°–æ–∑–¥–∞—ë–º .env.local:
```env
APP_ENV=local
OPENAI_API_KEY=<–≤–∞—à –∫–ª—é—á OpenAI>
BITRIX_WEBHOOK=<–≤–∞—à –≤–µ–±—Ö—É–∫ Bitrix24>
BOT_ID=<ID –±–æ—Ç–∞>
CLIENT_ID=<ID –∫–ª–∏–µ–Ω—Ç–∞>
GPT_MODEL=gpt-4o-mini
PROMPT_FILE=prompt.txt
```

### 5. –ó–∞–ø—É—Å–∫–∞–µ–º FastAPI:
```bash
uvicorn bot:app --host 0.0.0.0 --port 8000
```

### 6. –¢–µ—Å—Ç–∏—Ä—É–µ–º –±–æ—Ç–∞ —á–µ—Ä–µ–∑ curl:
```bash
curl -X POST http://localhost:8000/bot \
  -F 'event=test' \
  -F 'data[PARAMS][DIALOG_ID]=123' \
  -F 'data[PARAMS][MESSAGE]=–ü—Ä–∏–≤–µ—Ç' \
  -F 'data[USER][FIRST_NAME]=–î–µ–Ω–∏—Å'
```

## üê≥ –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Docker

### 1. –°–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:
```bash
docker-compose build
```

### 2. –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–±–æ—Ç + Redis):
```bash
docker-compose up -d
```

### 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ –±–æ—Ç–∞:
```bash
docker logs -f gpt_bot
```

### 4. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:
```bash
docker-compose down
```

## üîß Docker –∫–æ–º–∞–Ω–¥—ã

### –ü—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:
```bash
docker ps
```

### –í–æ–π—Ç–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:
```bash
docker exec -it gpt_bot bash
```

### –í–æ–π—Ç–∏ –≤ Redis CLI:
```bash
docker exec -it redis_chat redis-cli
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞:
```redis
GET dialog:<dialog_id>
```

## üíæ –•—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏

–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–æ–≤ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ Redis.

**–ö–ª—é—á:** `dialog:<dialog_id>`

**–§–æ—Ä–º–∞—Ç JSON:**
```json
[
  {"role": "user", "content": "–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"},
  {"role": "assistant", "content": "–û—Ç–≤–µ—Ç –±–æ—Ç–∞"}
]
```

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

- `.env.local` ‚Äî –ª–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
- `.env.prod` ‚Äî –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä
- –ü—Ä–æ–º–ø—Ç –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –≤ `prompt.txt` –∏ –∑–∞–≥—Ä—É–∂–∞—Ç—å —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `PROMPT_FILE`

### –ü—Ä–∏–º–µ—Ä .env.prod:
```env
APP_ENV=prod
OPENAI_API_KEY=<–∫–ª—é—á OpenAI>
BITRIX_WEBHOOK=<–≤–µ–±—Ö—É–∫ Bitrix24>
BOT_ID=<ID –±–æ—Ç–∞>
CLIENT_ID=<ID –∫–ª–∏–µ–Ω—Ç–∞>
GPT_MODEL=gpt-4o-mini
PROMPT_FILE=prompt.txt
```

## üìù –õ–æ–≥–∏

–ë–æ—Ç –º–æ–∂–µ—Ç –ø–∏—Å–∞—Ç—å –ª–æ–≥–∏ –≤ `bot.log` –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.

–ú–æ–∂–Ω–æ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ volume:
```yaml
volumes:
  - ./bot.log:/app/bot.log
```

## üí° –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

- –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –æ—Ç–≤–µ—Ç–æ–º ‚Äî 30 —Å–µ–∫—É–Ω–¥ (–≤ `bot.py`)
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ ‚Äî 50 –ø–∞—Ä —Å–æ–æ–±—â–µ–Ω–∏–π
- –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ OpenAI –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∏–ª–∏ —Ç–∞–π–º–∞—É—Ç–∞—Ö
- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ Bitrix24 —á–µ—Ä–µ–∑ –≤–µ–±—Ö—É–∫

## üöÄ –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä

### 1. –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É —á–µ—Ä–µ–∑ SSH:
```bash
ssh user@your_server_ip
```

### 2. –ö–æ–ø–∏—Ä—É–µ–º –ø—Ä–æ–µ–∫—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ `git clone`

### 3. –°–æ–∑–¥–∞—ë–º .env.prod –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:
```bash
nano .env.prod
```

### 4. –°–æ–±–∏—Ä–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:
```bash
docker-compose build
docker-compose up -d
```

### 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç—É –±–æ—Ç–∞ —á–µ—Ä–µ–∑ curl –∏–ª–∏ –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ Bitrix24

## ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π –±–æ—Ç:
```bash
curl -X POST http://localhost:8000/bot \
  -F 'event=test' \
  -F 'data[PARAMS][DIALOG_ID]=123' \
  -F 'data[PARAMS][MESSAGE]=–ü—Ä–∏–≤–µ—Ç' \
  -F 'data[USER][FIRST_NAME]=–î–µ–Ω–∏—Å'
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –≤ Redis:
```bash
docker exec -it redis_chat redis-cli
GET dialog:123
```